#!/bin/bash

# ----------------------------------------
# YTSubConverter + yt-dlp interactive downloader
#
# Modes:
#   (none)     -> keep video + ASS in folder
#   -burn      -> burn subtitles, auto cleanup, MP4 output
#   -burn-e    -> edit ASS before burning, MP4 output
#   -soft      -> mux ASS as soft subtitle track, MKV output, default track
#   -soft-e    -> edit ASS before muxing, MKV output, default track
# ----------------------------------------

# -------- HELP handling --------
for arg in "$@"; do
    if [[ "$arg" == "-help" ]]; then
        cat <<'EOF'

YTSubConverter + yt-dlp interactive downloader

Usage:
  srv3 <YouTube URL> [MODE]

Modes:
  (none)     -> Download video + ASS subtitles, keep everything in folder
  -burn      -> Burn subtitles into video, MP4 output, auto cleanup
  -burn-e    -> Edit ASS subtitles before burning, MP4 output
  -soft      -> Mux ASS as soft subtitle track (default track), MKV output
  -soft-e    -> Edit ASS subtitles before muxing, MKV output, default track
  -help      -> Display this help message

Example:
  srv3 https://www.youtube.com/watch?v=example -burn-e

EOF
        exit 0
    fi
done

# -------- argument handling --------
URL="$1"
MODE="normal"

if [ -z "$URL" ]; then
    echo "Usage: $0 <YouTube URL> [-burn | -burn-e | -soft | -soft-e | -help]"
    exit 1
fi

case "$2" in
    -burn)    MODE="burn" ;;
    -burn-e)  MODE="burn-edit" ;;
    -soft)    MODE="soft" ;;
    -soft-e)  MODE="soft-edit" ;;
esac

# -------- dependency checks --------
command -v yt-dlp >/dev/null || { echo "yt-dlp not installed"; exit 1; }
command -v ytsubconverter >/dev/null || { echo "YTSubConverter not found"; exit 1; }

if [[ "$MODE" != "normal" ]] && ! command -v ffmpeg >/dev/null; then
    echo "ffmpeg is required for this mode"
    exit 1
fi

# -------- default editor: micro --------
EDITOR_CMD="${EDITOR:-micro}"

# -------- directories --------
VIDEOS_DIR="$HOME/Videos"
TEMP_DIR="$VIDEOS_DIR/xx1.temp.1xx"

# -------- cleanup leftover temp directory --------
if [ -d "$TEMP_DIR" ]; then
    echo "Removing leftover temporary directory: $TEMP_DIR"
    rm -rf "$TEMP_DIR"
fi

# -------- metadata --------
VIDEO_TITLE=$(yt-dlp --get-title "$URL")
SAFE_TITLE=$(echo "$VIDEO_TITLE" | sed 's#[/:]#_#g')

# -------- format selection --------
echo "Available formats for \"$VIDEO_TITLE\":"
yt-dlp -F "$URL"
read -p "Enter the format code you want to download: " FORMAT_CODE

# -------- quality suffix --------
FORMAT_INFO=$(yt-dlp -F "$URL" | grep "^$FORMAT_CODE " | awk '{print $3,$4}')
QUALITY_SUFFIX=$(echo "$FORMAT_INFO" | tr -d ' ')

# -------- destination handling --------
if [[ "$MODE" == "normal" ]]; then
    DEST_DIR="$VIDEOS_DIR/${SAFE_TITLE}_${QUALITY_SUFFIX}"
    mkdir -p "$DEST_DIR"
else
    DEST_DIR="$TEMP_DIR"
    mkdir -p "$DEST_DIR"
fi

# -------- download --------
yt-dlp "$URL" \
    -f "$FORMAT_CODE" \
    --write-subs \
    --sub-format srv3 \
    -o "$DEST_DIR/%(title)s.%(ext)s"

echo "Download complete."

# -------- find downloaded video file --------
VIDEO_FILE=$(ls "$DEST_DIR"/* | grep -E '\.(mp4|mkv|webm|avi|flv|mov|m4a|3gp|ogg|ogv|ts|wmv)$' | head -n 1)
if [ -z "$VIDEO_FILE" ]; then
    echo "Error: no video file found in $DEST_DIR"
    exit 1
fi

VIDEO_EXT="${VIDEO_FILE##*.}"

# -------- convert subtitles --------
ASS_FILE=""
for file in "$DEST_DIR"/*.srv3; do
    [ -f "$file" ] || continue
    ASS_FILE="${file%.srv3}.ass"
    echo "Converting '$file' -> '$ASS_FILE'..."
    ytsubconverter "$file" "$ASS_FILE" || exit 1
    rm "$file"
done

# -------- edit subtitles if requested --------
if [[ "$MODE" == "burn-edit" || "$MODE" == "soft-edit" ]]; then
    echo
    echo "Editing ASS file in micro:"
    echo "$ASS_FILE"
    echo "Save and exit to continue."
    echo
    "$EDITOR_CMD" "$ASS_FILE"
fi

# -------- process only if not normal mode --------
if [[ "$MODE" != "normal" ]]; then

    # -------- get video resolution --------
    RESOLUTION=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of csv=p=0 "$VIDEO_FILE")
    RESOLUTION="${RESOLUTION}p"

    # -------- set output filename --------
    if [[ "$MODE" == soft* ]]; then
        FINAL_OUTPUT="$VIDEOS_DIR/${SAFE_TITLE}_${RESOLUTION}.mkv"
    else
        FINAL_OUTPUT="$VIDEOS_DIR/${SAFE_TITLE}_${RESOLUTION}.mp4"
    fi

    # -------- process video --------
    if [[ "$MODE" == "burn" || "$MODE" == "burn-edit" ]]; then
        echo "Burning subtitles into video..."
        ffmpeg -y \
            -i "$VIDEO_FILE" \
            -vf "ass=$(printf '%q' "$ASS_FILE")" \
            -c:a copy \
            "$FINAL_OUTPUT"

    elif [[ "$MODE" == "soft" || "$MODE" == "soft-edit" ]]; then
        echo "Muxing ASS subtitles as soft subtrack (default)..."
        ffmpeg -y \
            -i "$VIDEO_FILE" \
            -i "$ASS_FILE" \
            -map 0:v \
            -map 0:a? \
            -map 1:0 \
            -c copy \
            -metadata:s:s:0 language=eng \
            -disposition:s:0 default \
            "$FINAL_OUTPUT"
    fi

    # -------- cleanup --------
    echo "Cleaning up temporary files..."
    rm -rf "$DEST_DIR"
fi

echo "All done!"
